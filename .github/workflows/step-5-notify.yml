name: ðŸ“£ Step 5 - Notify

on:
  workflow_call:
    inputs:
      releaseResult:
        required: true
        type: string
      deployResult:
        required: true
        type: string

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ§  Set Notification Variables
        id: vars
        run: |
          RELEASE="${{ inputs.releaseResult }}"
          DEPLOY="${{ inputs.deployResult }}"

          if [[ "$RELEASE" == "success" ]]; then
            if [[ "$DEPLOY" == "success" ]]; then
              TITLE="âœ… Release & Deploy Succeeded"
              MESSAGE="Release and deployment completed successfully."
              STATUS="success"
            elif [[ "$DEPLOY" == "skipped" ]]; then
              TITLE="âœ… Release Succeeded (No Deploy)"
              MESSAGE="Release completed successfully."
              STATUS="neutral"
            else
              TITLE="âš ï¸ Release Succeeded, Deploy Failed"
              MESSAGE="Release completed, but deployment failed."
              STATUS="failure"
            fi
          else
            TITLE="âŒ Release Failed"
            MESSAGE="Release failed."
            STATUS="failure"
          fi

          echo "title=$TITLE" >> "$GITHUB_OUTPUT"
          echo "message=$MESSAGE" >> "$GITHUB_OUTPUT"
          echo "status=$STATUS" >> "$GITHUB_OUTPUT"

      - name: ðŸ“¢ Send Slack Notification (if configured)
        if: ${{ env.SLACK_WEBHOOK != '' }}
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "*${{ steps.vars.outputs.title }}* - `${{ github.repository }}`",
              "attachments": [
                {
                  "text": "${{ steps.vars.outputs.message }}",
                  "color": "${{ steps.vars.outputs.status == 'success' && 'good' || steps.vars.outputs.status == 'failure' && 'danger' || '#cccccc' }}"
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

      - name: ðŸ“¢ Send Discord Notification (if configured)
        if: ${{ env.DISCORD_WEBHOOK != '' }}
        run: |
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"username\":\"GitHub CI\",\"embeds\":[{\"title\":\"${{ steps.vars.outputs.title }}\",\"description\":\"${{ steps.vars.outputs.message }}\",\"color\":${{ steps.vars.outputs.status == 'success' && 3066993 || steps.vars.outputs.status == 'failure' && 15158332 || 9807270 }} }]}" \
               $DISCORD_WEBHOOK
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      - name: ðŸ“¢ Notify Microsoft Teams (if configured)
        if: ${{ env.MSTEAMS_WEBHOOK != '' }}
        run: |
          curl -H "Content-Type: application/json" \
               -d '{
                     "@type": "MessageCard",
                     "@context": "http://schema.org/extensions",
                     "summary": "CI/CD Notification",
                     "themeColor": "${{ steps.vars.outputs.status == 'success' && '00FF00' || steps.vars.outputs.status == 'failure' && 'FF0000' || '999999' }}",
                     "title": "${{ steps.vars.outputs.title }}",
                     "text": "${{ steps.vars.outputs.message }}"
                   }' \
               ${{ secrets.MSTEAMS_WEBHOOK }}
        env:
          MSTEAMS_WEBHOOK: ${{ secrets.MSTEAMS_WEBHOOK }}        