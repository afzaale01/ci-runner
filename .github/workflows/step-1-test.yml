name: ğŸ“‹ Step 1 - Test

on:
  workflow_call:
    inputs:
      unityVersion:
        description: "Unity version to use"
        required: false
        default: 'auto'
        type: string
      useGitLfs:
        description: "Whether to use Git LFS (true/false)"
        required: false
        default: 'true'
        type: string
      editModePath:
        description: "Path to the EditMode tests folder"
        required: false
        default: 'Assets/Tests/Editor'
        type: string
      playModePath:
        description: "Path to the PlayMode tests folder"
        required: false
        default: 'Assets/Tests/PlayMode'
        type: string
      timeoutMinutes:
        description: "Timeout for each test job in minutes"
        required: false
        default: 15
        type: number
      quietMode:
        description: "Enable quiet mode to suppress uploads/logs unless tests fail"
        required: false
        default: 'false'
        type: string
    secrets:
      UNITY_EMAIL:
        required: true
      UNITY_PASSWORD:
        required: true
      UNITY_LICENSE:
        required: true

jobs:
  upload_unity_license:
    name: ğŸ“¥ï¸ Upload Unity License
    uses: ./.github/workflows/unity-license-uploader.yml
    secrets:
      inherit

  detect_tests:
    name: ğŸ” Detect Tests
    uses: ./.github/workflows/unity-tests-detection.yml
    with:
      editModePath: ${{ inputs.editModePath }}
      playModePath: ${{ inputs.playModePath }}

  run_editmode:
    name: ğŸ¥ª EditMode Tests
    needs: 
      - detect_tests
      - upload_unity_license
    if: needs.detect_tests.outputs.has_editmode == 'true'
    uses: ./.github/workflows/unity-tests-runner.yml
    with:
      testMode: EditMode
      unityVersion: ${{ inputs.unityVersion }}
      useGitLfs: ${{ inputs.useGitLfs }}
      timeoutMinutes: ${{ inputs.timeoutMinutes }}
      quietMode: ${{ inputs.quietMode }}
    secrets: inherit

  run_playmode:
    name: ğŸ® PlayMode Tests
    needs: 
      - detect_tests
      - upload_unity_license
    if: needs.detect_tests.outputs.has_playmode == 'true'
    uses: ./.github/workflows/unity-tests-runner.yml
    with:
      testMode: PlayMode
      unityVersion: ${{ inputs.unityVersion }}
      useGitLfs: ${{ inputs.useGitLfs }}
      timeoutMinutes: ${{ inputs.timeoutMinutes }}
      quietMode: ${{ inputs.quietMode }}
    secrets: inherit

  summarize_tests:
    name: ğŸ“„ Summarize Test Results
    needs: [run_editmode, run_playmode]
    if: |
      always() &&
      (
        inputs.quietMode == 'false' ||
        (needs.run_editmode.result == 'success' && needs.run_editmode.outputs.failed == 'true') ||
        (needs.run_playmode.result == 'success' && needs.run_playmode.outputs.failed == 'true')
      )
    uses: ./.github/workflows/summarize-tests.yml
    with:
      quietMode: ${{ inputs.quietMode }}
      editmodeFailed: ${{ needs.run_editmode.outputs.failed }}
      playmodeFailed: ${{ needs.run_playmode.outputs.failed }}
      editmodeTotal: ${{ needs.run_editmode.outputs.total }}
      editmodePassed: ${{ needs.run_editmode.outputs.passed }}
      editmodeResult: ${{ needs.run_editmode.outputs.result }}
      editmodeDuration: ${{ needs.run_editmode.outputs.duration }}
      playmodeTotal: ${{ needs.run_playmode.outputs.total }}
      playmodePassed: ${{ needs.run_playmode.outputs.passed }}
      playmodeResult: ${{ needs.run_playmode.outputs.result }}
      playmodeDuration: ${{ needs.run_playmode.outputs.duration }}