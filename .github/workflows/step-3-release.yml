name: ðŸ“¦ Step 3 - Release

on:
  workflow_call:
    inputs:
      buildType:
        description: "Build type: 'preview' | 'release_candidate' | 'release'"
        type: string
        required: true
      version:
        description: "The version/tag name (e.g., v1.2.3)"
        type: string
        required: true
      projectName:
        description: "Project name used in the artifact"
        type: string
        required: true
      targetPlatforms:
        description: "JSON array of platforms to expect artifacts for"
        type: string
        required: true
      combineArtifacts:
        description: "Whether to upload the combined artifact to the release"
        type: string
        default: "false"
        required: false
      skipPerPlatformArtifacts:
        description: "Whether to skip uploading per-platform artifacts"
        type: string
        default: "false"
        required: false      
    outputs:
      releaseErrorMessage:
        description: "Error message if release failed"
        value: ${{ jobs.publish.outputs.releaseErrorMessage }}
      versionUsed:
        description: "The resolved version or tag used"
        value: ${{ jobs.tag.outputs.version }}

jobs:
  tag:
    name: ðŸ·ï¸ Ensure Git Tag Exists
    uses: avalin/unity-ci-templates/.github/workflows/resolve-and-create-tag.yml@main
    with:
      version: ${{ inputs.version }}
    secrets: inherit

  publish:
    if: ${{ inputs.buildType == 'release' || inputs.buildType == 'release_candidate' }}
    name: ðŸ“¤ Publish GitHub Release
    needs: tag
    runs-on: ubuntu-latest
    outputs:
      releaseErrorMessage: ${{ steps.error-handler.outputs.releaseErrorMessage }}
      versionUsed: ${{ needs.tag.outputs.version }}

    steps:
      - name: ðŸ“ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: .

      - name: ðŸ§° Setup Helper Scripts
        run: chmod +x .github/scripts/release/*.sh

      - name: ðŸ“ Check if Release Already Exists
        id: check_release
        run: .github/scripts/release/check-release-exists.sh "${{ needs.tag.outputs.version }}" "${{ github.repository }}" "$GITHUB_TOKEN"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ·ï¸ Show Resolved Version
        run: |
          VERSION="${{ needs.tag.outputs.version }}"
          echo "ðŸ“Œ Resolved version from tag job: $VERSION"
          echo "### ðŸ·ï¸ Release Version Used" >> $GITHUB_STEP_SUMMARY
          echo "Tagged version for release: \`$VERSION\`" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“ Create GitHub Release
        if: ${{ steps.check_release.outputs.exists != 'true' }}
        id: create_release
        run: |
          VERSION="${{ needs.tag.outputs.version }}"
          BUILD_TYPE="${{ inputs.buildType }}"

          IS_PRERELEASE=$([[ "$VERSION" == *-* ]] && echo true || echo false)
          IS_DRAFT=$([[ "$BUILD_TYPE" == "release_candidate" ]] && echo true || echo false)

          echo "ðŸ“ Creating GitHub release for tag: $VERSION (prerelease: $IS_PRERELEASE, draft: $IS_DRAFT)"

          PAYLOAD=$(jq -n \
            --arg tag_name "$VERSION" \
            --arg name "Release $VERSION" \
            --argjson prerelease "$IS_PRERELEASE" \
            --argjson draft "$IS_DRAFT" \
            '{ tag_name: $tag_name, name: $name, draft: $draft, prerelease: $prerelease }')

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d "$PAYLOAD" \
            "https://api.github.com/repos/${{ github.repository }}/releases")

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [[ -z "$RELEASE_ID" || "$RELEASE_ID" == "null" ]]; then
            echo "âŒ Failed to create release. Full response:"
            echo "$RESPONSE"
            exit 1
          fi

          echo "release_id=$RELEASE_ID" >> "$GITHUB_OUTPUT"
          echo "âœ… Created release with ID: $RELEASE_ID"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§® Upload Per-Platform Artifacts
        if: ${{ inputs.skipPerPlatformArtifacts != 'true' }}
        run: |
          VERSION="${{ needs.tag.outputs.version }}"
          RELEASE_ID="${{ steps.check_release.outputs.release_id || steps.create_release.outputs.release_id }}"
          .github/scripts/release/upload-artifacts.sh \
            "${{ inputs.projectName }}" \
            "$VERSION" \
            "$RELEASE_ID" \
            "${{ github.repository }}" \
            "$GITHUB_TOKEN" \
            '${{ inputs.targetPlatforms }}'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ§® Upload Combined Artifact
        if: ${{ inputs.combineArtifacts == 'true' }}
        run: |
          VERSION="${{ needs.tag.outputs.version }}"
          PROJECT="${{ inputs.projectName }}"
          COMBINED_PATH="${PROJECT}-${VERSION}"
          COMBINED_ZIP="${PROJECT}-${VERSION}-all-platforms.zip"

          RELEASE_ID="${{ steps.check_release.outputs.release_id || steps.create_release.outputs.release_id }}"

          if [ -d "$COMBINED_PATH" ]; then
            echo "ðŸ“¦ Zipping contents of: $COMBINED_PATH â†’ $COMBINED_ZIP"
            cd "$COMBINED_PATH"
            zip -r "../$COMBINED_ZIP" .
            cd -

            echo "ðŸ“¤ Uploading $COMBINED_ZIP to release ID $RELEASE_ID"
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/zip" \
              --data-binary @"$COMBINED_ZIP" \
              "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$COMBINED_ZIP"
          else
            echo "â„¹ï¸ No combined build artifact found â€” skipping."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ› ï¸ Capture Release Errors
        if: failure()
        id: error-handler
        run: |
          ERROR_MESSAGE="Unknown release failure"

          if ! ls * >/dev/null 2>&1; then
            ERROR_MESSAGE="No artifacts found"
          elif ! jq -e .id response.json >/dev/null 2>&1; then
            ERROR_MESSAGE="Failed to create or fetch GitHub Release"
          else
            ERROR_MESSAGE="One or more upload steps failed"
          fi

          echo "releaseErrorMessage=$ERROR_MESSAGE" >> "$GITHUB_OUTPUT"